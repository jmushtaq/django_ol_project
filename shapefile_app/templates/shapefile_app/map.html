<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shapefile Viewer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <style>
    .map {
      width: 80%;
      height: 600px;
    }
    .layer-control {
      position: absolute;
      top: 0.5em;
      right: 0.5em;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      max-width: 300px;
    }
    .layer-control-header {
      padding: 0.5em;
      border-bottom: 1px solid #dee2e6;
      cursor: move;
      background: #f8f9fa;
    }
    .layer-control-body {
      padding: 0.5em;
      max-height: 400px;
      overflow-y: auto;
    }
    .layer-group {
      margin-bottom: 0.5em;
      padding-bottom: 0.5em;
      border-bottom: 1px solid #eee;
    }
    .layer-group:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    .form-check {
      margin-bottom: 0.25em;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="{% url 'map_view' %}">Shapefile Viewer</a>
      <div class="navbar-nav">
        <a class="nav-link" href="{% url 'upload_shapefile' %}">Upload Shapefile</a>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-3">
    <div id="map" class="map"></div>
  </div>

  <div id="layer-control" class="layer-control">
    <div class="layer-control-header">
      <h6 class="mb-0">Layers</h6>
    </div>
    <div class="layer-control-body">
      <div id="layer-list">
        {% for shapefile in shapefiles %}
        <div class="layer-group">
          <div class="form-check">
            <input class="form-check-input layer-checkbox" 
                   type="checkbox" 
                   value="{{ shapefile.id }}" 
                   id="layer{{ shapefile.id }}"
                   data-layer-type="original"
                   checked>
            <label class="form-check-label" for="layer{{ shapefile.id }}">
              {{ shapefile.name }} (Original)
            </label>
          </div>
          
          {% if shapefile.geojson_data_processed %}
          <div class="form-check ms-3">
            <input class="form-check-input layer-checkbox" 
                   type="checkbox" 
                   value="{{ shapefile.id }}" 
                   id="layer{{ shapefile.id }}_processed"
                   data-layer-type="processed"
                   checked>
            <label class="form-check-label" for="layer{{ shapefile.id }}_processed">
              {{ shapefile.name }} (Processed)
            </label>
          </div>
          {% endif %}
          
          <div class="mt-1">
            <a href="{% url 'debug_shapefile' shapefile.id %}" class="btn btn-sm btn-outline-info" target="_blank">
              Debug
            </a>
          </div>
        </div>
        {% empty %}
        <p class="text-muted small">No shapefiles uploaded yet.</p>
        {% endfor %}
      </div>
      
      <div class="mt-3">
        <a href="{% url 'upload_shapefile' %}" class="btn btn-primary btn-sm w-100">Upload New Shapefile</a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Western Australia bounds (approximate)
    const WA_BOUNDS = [112.5, -35.5, 129.0, -13.5];

    // Initialize map
    const map = new ol.Map({
      target: 'map',
      layers: [
        new ol.layer.Tile({
          source: new ol.source.OSM()
        })
      ],
      view: new ol.View({
        center: ol.proj.fromLonLat([120.5, -24.5]),
        zoom: 6
      })
    });

    // Fit map to Western Australia bounds
    const waExtent = ol.proj.transformExtent(WA_BOUNDS, 'EPSG:4326', 'EPSG:3857');
    map.getView().fit(waExtent, { padding: [50, 50, 50, 50] });

    // Store layer references
    const shapefileLayers = {};

    // Function to load and display shapefile
    function loadShapefile(shapefileId, layerType = 'original') {
      const layerKey = `${shapefileId}_${layerType}`;
      
      if (shapefileLayers[layerKey]) {
        shapefileLayers[layerKey].setVisible(true);
        zoomToLayer(shapefileLayers[layerKey]);
        return;
      }

      const url = layerType === 'processed' 
        ? `/shapefile/${shapefileId}/geojson/processed/`
        : `/shapefile/${shapefileId}/geojson/`;

      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(geojsonData => {
          const vectorSource = new ol.source.Vector({
            features: new ol.format.GeoJSON().readFeatures(geojsonData, {
              dataProjection: 'EPSG:4326',
              featureProjection: 'EPSG:3857'
            })
          });

          const style = layerType === 'processed' 
            ? new ol.style.Style({
                stroke: new ol.style.Stroke({ color: 'red', width: 3 }),
                fill: new ol.style.Fill({ color: 'rgba(255, 0, 0, 0.2)' })
              })
            : new ol.style.Style({
                stroke: new ol.style.Stroke({ color: 'blue', width: 2 }),
                fill: new ol.style.Fill({ color: 'rgba(0, 0, 255, 0.1)' })
              });

          const vectorLayer = new ol.layer.Vector({ source: vectorSource, style: style });
          map.addLayer(vectorLayer);
          shapefileLayers[layerKey] = vectorLayer;
          zoomToLayer(vectorLayer);
        })
        .catch(error => {
          console.error(`Error loading ${layerType} shapefile:`, error);
        });
    }

    // Function to remove shapefile layer
    function removeShapefile(shapefileId, layerType = 'original') {
      const layerKey = `${shapefileId}_${layerType}`;
      if (shapefileLayers[layerKey]) {
        map.removeLayer(shapefileLayers[layerKey]);
        delete shapefileLayers[layerKey];
        
        if (Object.keys(shapefileLayers).length === 0) {
          map.getView().fit(waExtent, { padding: [50, 50, 50, 50], duration: 1000 });
        }
      }
    }

    // Function to zoom to a specific layer
    function zoomToLayer(layer) {
      const source = layer.getSource();
      const extent = source.getExtent();
      
      if (!ol.extent.isEmpty(extent)) {
        map.getView().fit(extent, {
          padding: [50, 50, 50, 50],
          maxZoom: 15,
          duration: 1000
        });
      }
    }

    // Handle layer checkbox changes
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('layer-checkbox')) {
        const shapefileId = e.target.value;
        const layerType = e.target.dataset.layerType;
        
        if (e.target.checked) {
          loadShapefile(shapefileId, layerType);
        } else {
          removeShapefile(shapefileId, layerType);
        }
      }
    });

    // Load all checked layers initially
    document.querySelectorAll('.layer-checkbox:checked').forEach(checkbox => {
      const shapefileId = checkbox.value;
      const layerType = checkbox.dataset.layerType;
      loadShapefile(shapefileId, layerType);
    });

    // Auto-zoom to newly uploaded shapefile
    const urlParams = new URLSearchParams(window.location.search);
    const zoomToId = urlParams.get('zoom_to');
    
    if (zoomToId) {
      Object.keys(shapefileLayers).forEach(layerKey => {
        if (layerKey.startsWith(`${zoomToId}_`)) {
          const [shapefileId, layerType] = layerKey.split('_');
          removeShapefile(shapefileId, layerType);
        }
      });
      
      setTimeout(() => {
        const originalCheckbox = document.getElementById(`layer${zoomToId}`);
        if (originalCheckbox) {
          originalCheckbox.checked = true;
          loadShapefile(zoomToId, 'original');
        }
      }, 500);
      
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    // Make layer control draggable
    const layerControl = document.getElementById('layer-control');
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;

    layerControl.querySelector('.layer-control-header').addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);

    function dragStart(e) {
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;

      if (e.target === layerControl.querySelector('.layer-control-header')) {
        isDragging = true;
      }
    }

    function drag(e) {
      if (isDragging) {
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;

        xOffset = currentX;
        yOffset = currentY;

        setTranslate(currentX, currentY, layerControl);
      }
    }

    function setTranslate(xPos, yPos, el) {
      el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
    }

    function dragEnd(e) {
      initialX = currentX;
      initialY = currentY;
      isDragging = false;
    }
  </script>
</body>
</html>
